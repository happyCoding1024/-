之前在实习时候踩过一次坑，在本地可以，但是只要发布到线上就会出问题。原因就在于 package-lock.json 没有搞清楚。

在 npm 更新到 5.x 版本后，npm i 的规则发生了三次变化。

1）npm 5.0.x 版本，不管 package.json怎么变，npm i 都会根据 package-lock.json 中的版本去下载。

[package-lock.json file not updated after package.json file is changed · Issue #16866 · npm/npm](https://link.zhihu.com/?target=https%3A//github.com/npm/npm/issues/16866)

这个 issue 控诉了这个问题，明明手动改了package.json，为啥不给我升级包！然后就导致了5.1.0的问题..】

2）5.1.0 版本后，npm i 会忽略 package-lock.json 文件根据 package.json 中包的版本去下载。

然后有人提了这个issue [why is package-lock being ignored? · Issue #17979 · npm/npm](https://link.zhihu.com/?target=https%3A//github.com/npm/npm/issues/17979)

控诉这个问题，最后演变成5.4.2版本后的规则。

3）5.4.2 版本后，变成了现在的样子。

如果改了 package.json 并且 package.json 和 package-lock.json 文件不同，那么执行 npm i 时会根据 package 中的版本号以及语义含义去下载最新的包，并更新至 package-lock.json 文件。

下面演示一下：

执行以下命令安装

```
npm i express --save
```

安装完后，package.json 和 package-lock.json 文件的内容如下：

![https://gitee.com/codingOrange/image-hosting/raw/master/img/20201226194844.png](https://gitee.com/codingOrange/image-hosting/raw/master/img/20201226194844.png)

![https://gitee.com/codingOrange/image-hosting/raw/master/img/20201226195441.png](https://gitee.com/codingOrange/image-hosting/raw/master/img/20201226195441.png)

可以发现都是最新的 4.17.1 版本。

接下来将 package.json 文件中 express 的版本变为 ^4.16.1。

![https://gitee.com/codingOrange/image-hosting/raw/master/img/20201226200438.png](https://gitee.com/codingOrange/image-hosting/raw/master/img/20201226200438.png)

我们再来执行 npm i，这个时候你会发现 package-lock.json 和 node_modules 中 express 的版本还是 4.17.1。

![https://gitee.com/codingOrange/image-hosting/raw/master/img/20201226200559.png](https://gitee.com/codingOrange/image-hosting/raw/master/img/20201226200559.png)

![https://gitee.com/codingOrange/image-hosting/raw/master/img/1608984410239.png](https://gitee.com/codingOrange/image-hosting/raw/master/img/1608984410239.png)

有个问题，package.json 中的版本号明明和package-lock.json中的不一样，怎么不发生变化呢。这里牵扯到另外一个知识点。

```
// package.json
  "dependencies": {
    "express": "^4.16.1"
  }
```

这里向上标号 `^` 是定义了向后(新)兼容依赖，指如果 express 的版本超过 4.16.1 并在大版本(4)号上相同，那么就允许下载最新版本的 express 包。所以，这里和 package-lock.json 比对后发现 package-lock.json 中的包比较新就去下载那个新的包了。

如果我现在就想用之前的包怎么办，那么可以将前面的 `^` 去掉，然后重新执行 npm i 即可，你会发现 package-lock.json 中 express 的版本号也变成了 4.16.1。